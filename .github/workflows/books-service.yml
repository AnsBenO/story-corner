name: Books Service

on:
    push:
        paths:
            - books-service/**
        branches:
            - "**"
    pull_request:
        branches: [main]

jobs:
    build:
        name: Build
        runs-on: ubuntu-latest
        env:
            working-directory: ./books-service
            DOCKER_IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/storycorner-books-service
        defaults:
            run:
                working-directory: ${{ env.working-directory }}
        steps:
            - uses: actions/checkout@v4

            - name: Setup Java 21
              uses: actions/setup-java@v4
              with:
                  java-version: "21"
                  distribution: "temurin"
                  cache: "maven"

            - name: Make Maven wrapper executable
              run: chmod +x mvnw

            - name: Build with Maven
              run: ./mvnw -ntp verify

            - if: ${{ github.ref == 'refs/heads/main' }}
              name: Login to Docker Hub
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_TOKEN }}

            - if: ${{ github.ref == 'refs/heads/main' }}
              name: Build Docker Image with Tag
              run: |
                  ./mvnw spring-boot:build-image -DskipTests -Dspring-boot.build-image.imageName=$DOCKER_IMAGE_NAME:latest
                  echo "Built Docker image $DOCKER_IMAGE_NAME:latest"

            - if: ${{ github.ref == 'refs/heads/main' }}
              name: List Docker Images (Debugging Step)
              run: docker images

            - if: ${{ github.ref == 'refs/heads/main' }}
              name: Push the Docker Image to Docker Hub
              run: |
                  echo "Pushing the image $DOCKER_IMAGE_NAME:latest to Docker Hub..."
                  docker push $DOCKER_IMAGE_NAME:latest
